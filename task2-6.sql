-- =============================================
-- ЧАСТЬ 1: СОЗДАНИЕ ТАБЛИЦ
-- =============================================

-- Создаем таблицу хронистов (участников гильдии)
CREATE TABLE chroniclers (
    -- id - уникальный идентификатор каждого хрониста
    -- PRIMARY KEY - гарантирует уникальность каждого id
    -- AUTO_INCREMENT - автоматически увеличивает номер при добавлении новой записи
    id INT PRIMARY KEY AUTO_INCREMENT,
    
    -- name - имя хрониста, не может быть пустым (NOT NULL)
    -- VARCHAR(100) - строка переменной длины до 100 символов
    name VARCHAR(100) NOT NULL,
    
    -- rank - ранг хрониста в гильдии
    -- Примеры: 'Новичок', 'Хранитель', 'Мастер Хроник'
    rank VARCHAR(50) NOT NULL,
    
    -- years_of_service - количество лет службы в гильдии
    -- INT - целое число
    -- CHECK - ограничение: стаж не может быть отрицательным
    years_of_service INT NOT NULL CHECK (years_of_service >= 0)
);

-- Создаем таблицу экспедиций (путешествий в забытые земли)
CREATE TABLE expeditions (
    -- id - уникальный идентификатор каждой экспедиции
    id INT PRIMARY KEY AUTO_INCREMENT,
    
    -- name - название экспедиции, должно быть уникальным
    -- UNIQUE - гарантирует, что не будет двух экспедиций с одинаковым названием
    name VARCHAR(150) NOT NULL UNIQUE,
    
    -- region - регион, где проходит экспедиция
    region VARCHAR(100) NOT NULL,
    
    -- danger_level - уровень опасности от 1 (низкий) до 5 (смертельный)
    -- CHECK - ограничение на допустимые значения (от 1 до 5)
    danger_level INT NOT NULL CHECK (danger_level BETWEEN 1 AND 5)
);

-- Создаем таблицу участия в экспедициях (связь между хронистами и экспедициями)
CREATE TABLE expedition_participation (
    -- id - уникальный идентификатор каждой записи об участии
    id INT PRIMARY KEY AUTO_INCREMENT,
    
    -- chronicler_id - ссылка на хрониста
    -- FOREIGN KEY - внешний ключ, который ссылается на таблицу chroniclers
    -- ON DELETE CASCADE - если удалить хрониста, автоматически удалятся все записи о его участии
    chronicler_id INT NOT NULL,
    FOREIGN KEY (chronicler_id) REFERENCES chroniclers(id) ON DELETE CASCADE,
    
    -- expedition_id - ссылка на экспедицию
    expedition_id INT NOT NULL,
    FOREIGN KEY (expedition_id) REFERENCES expeditions(id) ON DELETE CASCADE,
    
    -- role - роль хрониста в экспедиции
    -- ENUM - перечисление допустимых значений
    -- Это гарантирует, что роль будет только одной из трех указанных
    role ENUM('разведчик', 'писец', 'защитник') NOT NULL,
    
    -- gold_reward - награда в золотых монетах
    -- DECIMAL(10,2) - число с фиксированной точностью: 10 цифр всего, 2 после запятой
    -- CHECK - награда не может быть отрицательной
    gold_reward DECIMAL(10,2) NOT NULL CHECK (gold_reward >= 0),
    
    -- UNIQUE - один хронист не может участвовать в одной экспедиции дважды
    -- Это предотвращает дублирование записей
    UNIQUE(chronicler_id, expedition_id)
);

-- =============================================
-- ЧАСТЬ 2: ДОБАВЛЕНИЕ ДАННЫХ
-- (выполняем требования: 4+ хрониста, 3+ экспедиции, 6+ записей участия)
-- =============================================

-- Добавляем хронистов (требование: минимум 4)
INSERT INTO chroniclers (name, rank, years_of_service) VALUES
-- 1. Старший хронист с большим опытом
('Арлен Сигурдссон', 'Старший Хронист', 12),

-- 2. Опытная исследовательница
('Лираэль Зелёный Свиток', 'Хранитель Знаний', 8),

-- 3. Молодой, но сильный защитник
('Горм Каменная Длань', 'Страж Архива', 4),

-- 4. Начинающий писец
('Элиана Быстрое Перо', 'Младший Писец', 2),

-- 5. Дополнительный хронист для демонстрации
('Торин Рунный Мастер', 'Мастер Хроник', 15);

/*
Что мы только что добавили:
- 5 хронистов (выполняем требование "минимум 4")
- У каждого есть имя, ранг и стаж службы
- Разный уровень опыта: от 2 до 15 лет
*/

-- Добавляем экспедиции (требование: минимум 3)
INSERT INTO expeditions (name, region, danger_level) VALUES
-- 1. Опасная экспедиция в холодные земли
('Потерянные Холмы Арадор', 'Северные Пустоши', 4),

-- 2. Крайне опасная экспедиция в древний город
('Руины Забытого Города', 'Долина Теней', 5),

-- 3. Относительно безопасная исследовательская экспедиция
('Тайны Леса Веков', 'Древний Лес', 2),

-- 4. Дополнительная экспедиция для демонстрации
('Логово Спящего Дракона', 'Огненные Горы', 5);

/*
Что мы только что добавили:
- 4 экспедиции (выполняем требование "минимум 3")
- У каждой есть название, регион и уровень опасности (1-5)
- Разный уровень опасности: от 2 до 5
*/

-- Добавляем записи об участии (требование: минимум 6)
INSERT INTO expedition_participation (chronicler_id, expedition_id, role, gold_reward) VALUES
-- 1. Арлен участвует как писец в первой экспедиции
(1, 1, 'писец', 500.00),

-- 2. Арлен также участвует как разведчик во второй экспедиции
(1, 2, 'разведчик', 800.00),

-- 3. Лираэль как разведчик в первой экспедиции
(2, 1, 'разведчик', 450.00),

-- 4. Лираэль как писец в третьей экспедиции
(2, 3, 'писец', 300.00),

-- 5. Горм как защитник во второй экспедиции
(3, 2, 'защитник', 700.00),

-- 6. Горм как защитник в четвертой экспедиции
(3, 4, 'защитник', 950.00),

-- 7. Элиана как писец в третьей экспедиции
(4, 3, 'писец', 250.00),

-- 8. Торин как писец во второй экспедиции
(5, 2, 'писец', 600.00),

-- 9. Торин как разведчик в четвертой экспедиции
(5, 4, 'разведчик', 900.00);

/*
Что мы только что добавили:
- 9 записей об участии (выполняем требование "минимум 6")
- Каждый хронист участвует в 1-2 экспедициях
- Разные роли в разных экспедициях
- Разные награды в зависимости от опасности и роли
*/

-- =============================================
-- ЧАСТЬ 3: ВЫПОЛНЕНИЕ ЗАПРОСОВ ДЛЯ СОВЕТА СТАРЕЙШИН
-- =============================================

-- ЗАПРОС 1: Список всех хронистов
SELECT 
    -- Выбираем все поля из таблицы chroniclers
    id AS 'ID Хрониста',
    name AS 'Имя',
    rank AS 'Ранг в гильдии',
    years_of_service AS 'Лет службы',
    -- Добавляем вычисляемое поле для категоризации
    CASE 
        WHEN years_of_service >= 10 THEN 'Ветеран'
        WHEN years_of_service >= 5 THEN 'Опытный'
        ELSE 'Новичок'
    END AS 'Категория по опыту'
FROM chroniclers
-- Сортируем по стажу (от большего к меньшему), затем по имени
ORDER BY years_of_service DESC, name ASC;

/*
Результат этого запроса:
- Покажет всех 5 хронистов
- Отсортирует их по стажу службы
- Добавит категорию (Ветеран/Опытный/Новичок)
*/

-- ЗАПРОС 2: Хронисты с опытом службы более 5 лет
SELECT 
    name AS 'Имя Хрониста',
    rank AS 'Ранг',
    years_of_service AS 'Стаж (лет)',
    -- Форматируем вывод стажа
    CONCAT(years_of_service, ' лет службы') AS 'Полный стаж'
FROM chroniclers
-- WHERE - условие фильтрации: выбираем только тех, у кого стаж > 5 лет
WHERE years_of_service > 5
ORDER BY years_of_service DESC;

/*
Результат этого запроса:
- Покажет только хронистов со стажем более 5 лет
- В нашем случае: Арлен (12), Лираэль (8), Торин (15)
- Всего 3 хрониста соответствуют условию
*/

-- ЗАПРОС 3: Все экспедиции с уровнем опасности 4 и выше
SELECT 
    name AS 'Название экспедиции',
    region AS 'Регион проведения',
    danger_level AS 'Уровень опасности',
    -- Добавляем текстовое описание уровня опасности
    CASE 
        WHEN danger_level = 5 THEN '⚫⚫⚫⚫⚫ СМЕРТЕЛЬНО ОПАСНО'
        WHEN danger_level = 4 THEN '⚫⚫⚫⚫ ОЧЕНЬ ОПАСНО'
        WHEN danger_level = 3 THEN '⚫⚫⚫ ОПАСНО'
        WHEN danger_level = 2 THEN '⚫⚫ УМЕРЕННО ОПАСНО'
        ELSE '⚫ МАЛО ОПАСНО'
    END AS 'Оценка риска'
FROM expeditions
-- WHERE - условие: опасность 4 или 5
WHERE danger_level >= 4
-- Сортируем по уровню опасности (самые опасные - первыми)
ORDER BY danger_level DESC, name ASC;

/*
Результат этого запроса:
- Покажет экспедиции с опасностью 4 и 5
- В нашем случае: 
  * Руины Забытого Города (5)
  * Логово Спящего Дракона (5)  
  * Потерянные Холмы Арадор (4)
- Всего 3 экспедиции соответствуют условию
*/

-- ЗАПРОС 4: Кто и в каких экспедициях участвовал
SELECT 
    -- Берем данные из трех таблиц, объединенных через JOIN
    c.name AS 'Хронист',
    c.rank AS 'Ранг хрониста',
    e.name AS 'Экспедиция',
    e.region AS 'Регион экспедиции',
    ep.role AS 'Роль в экспедиции',
    e.danger_level AS 'Уровень опасности',
    -- Форматируем вывод награды
    CONCAT(ep.gold_reward, ' золотых') AS 'Награда'
FROM expedition_participation ep
-- INNER JOIN - объединяем таблицу участия с таблицей хронистов
JOIN chroniclers c ON ep.chronicler_id = c.id
-- INNER JOIN - объединяем таблицу участия с таблицей экспедиций  
JOIN expeditions e ON ep.expedition_id = e.id
-- Сортируем по опасности (самые опасные - первыми), затем по имени хрониста
ORDER BY e.danger_level DESC, c.name ASC;

/*
Результат этого запроса:
- Покажет все 9 записей об участии
- Для каждой записи покажет:
  * Имя хрониста и его ранг
  * Название и регион экспедиции
  * Роль, которую выполнял хронист
  * Уровень опасности и награду
*/

-- ЗАПРОС 5: Общая награда каждого хрониста
SELECT 
    c.name AS 'Хронист',
    c.rank AS 'Ранг',
    c.years_of_service AS 'Стаж (лет)',
    -- COUNT - подсчитываем количество экспедиций для каждого хрониста
    COUNT(ep.expedition_id) AS 'Количество экспедиций',
    -- SUM - суммируем все награды для каждого хрониста
    COALESCE(SUM(ep.gold_reward), 0) AS 'Общая награда (золото)',
    -- AVG - вычисляем среднюю награду за экспедицию
    COALESCE(AVG(ep.gold_reward), 0) AS 'Средняя награда за экспедицию',
    -- Категоризируем по общей награде
    CASE 
        WHEN COALESCE(SUM(ep.gold_reward), 0) = 0 THEN 'Нет наград'
        WHEN COALESCE(SUM(ep.gold_reward), 0) > 1000 THEN 'Высокооплачиваемый'
        WHEN COALESCE(SUM(ep.gold_reward), 0) > 500 THEN 'Средний доход'
        ELSE 'Начинающий'
    END AS 'Финансовый статус'
FROM chroniclers c
-- LEFT JOIN - показываем всех хронистов, даже если у них нет участий
LEFT JOIN expedition_participation ep ON c.id = ep.chronicler_id
-- GROUP BY - группируем результаты по каждому хронисту
GROUP BY c.id, c.name, c.rank, c.years_of_service
-- Сортируем по общей награде (от большей к меньшей)
ORDER BY SUM(ep.gold_reward) DESC;

/*
Результат этого запроса:
- Покажет всех 5 хронистов
- Для каждого вычислит:
  * Сколько экспедиций он прошел
  * Общую сумму всех наград
  * Среднюю награду за экспедицию
  * Финансовый статус
*/
